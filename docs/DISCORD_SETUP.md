# Настройка Discord-бота

## Команды не отображаются

1. **Приглашение бота** — при добавлении бота на сервер в [Discord Developer Portal](https://discord.com/developers/applications) → OAuth2 → URL Generator обязательно отметьте scope **`applications.commands`** и **`bot`**. Без `applications.commands` слэш-команды не появятся.

2. **Регистрация команд (моментально на сервере):**  
   Задайте в `.env` переменную **`DISCORD_DEV_GUILD_ID`** — ID сервера (гильдии). Команды будут регистрироваться только в указанных гильдиях (application guild commands) и появятся сразу после перезапуска бота.  
   Несколько серверов: перечислите ID через запятую, например `DISCORD_DEV_GUILD_ID=123,456,789`.  
   Как узнать ID: режим разработчика в Discord → ПКМ по иконке сервера → «Копировать ID сервера».  
   Если **`DISCORD_DEV_GUILD_ID`** не задан — команды регистрируются глобально (до 1 часа до появления на серверах).

3. **Права бота** — при инвайте выберите нужные права (например, «Управление каналами») или «Administrator» для полного доступа.

4. **Проверка** — команда **`/ping`** доступна всем.

## Сценарий 1: DISCORD_DEV_GUILD_ID задан

- Команды регистрируются только в указанной гильдии (application guild commands).
- Глобальные команды не создаются.

**Что проверить:**

1. **ID совпадает?**  
   `DISCORD_DEV_GUILD_ID` должен быть ID того сервера, куда добавлен бот.  
   Режим разработчика включён → ПКМ по серверу → Copy Server ID.  
   ID в `.env` должен полностью совпадать (даже одна цифра неверна — команды не появятся).

2. **Бот на этом сервере?**  
   При старте бот пишет в лог список гильдий: `[Discord] Guilds: <id1>, <id2>, ...`.  
   Убедитесь, что `DISCORD_DEV_GUILD_ID` есть в этом списке.

3. **Регистрация прошла?**  
   Не падает ли NestJS до события ready? Есть ли в логах `Successfully reloaded application commands` и `[Discord] Bot is online`?

## Сценарий 2: DISCORD_DEV_GUILD_ID убран

- Команды регистрируются глобально (application commands).
- Появление на серверах может занять до 1 часа.  
  Если ID только что убрали и команд ещё нет — это нормально, нужно подождать.

## Типичная проблема в Necord

Бот запущен, но слэш-команды не работают — часто из‑за того, что бот был добавлен **без scope `applications.commands`**.

**Что сделать:** перегенерировать OAuth-ссылку с `applications.commands`, удалить бота с сервера и добавить заново по новой ссылке.

## Рекомендованный режим

- **Моментальные команды:** задать `DISCORD_DEV_GUILD_ID=<id_сервера>` (или несколько через запятую) — команды регистрируются только в этих гильдиях и появляются сразу.
- **Глобальные команды:** не задавать `DISCORD_DEV_GUILD_ID` — команды появятся на всех серверах с ботом в течение до 1 часа.

## Быстрая диагностика

Ответьте для себя:

- Команды вообще не появляются в списке при вводе `/`, или появляются, но не срабатывают?
- Есть ли ошибки в консоли при старте NestJS?

При необходимости проверьте: конфиг Necord в `src/shared/discord/discord.module.ts`, точку входа в `src/main.ts`, `.env` (без токена).
